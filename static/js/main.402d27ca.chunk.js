(this["webpackJsonpvirtual-shot"]=this["webpackJsonpvirtual-shot"]||[]).push([[0],{32:function(e,t,n){e.exports=n(89)},37:function(e,t,n){},88:function(e,t,n){},89:function(e,t,n){"use strict";n.r(t);var a=n(0),r=n.n(a),c=n(31),i=n.n(c),u=(n(37),n(6)),o=n.n(u),s=n(9),l=n(8),d=n(10),f=n(14),h=n(15),b=new(function(){function e(){Object(f.a)(this,e)}return Object(h.a)(e,[{key:"_base64ToBlob",value:function(e){var t=e.slice(5).split(/[,;]/).pop();if(!t)throw new Error("base64 parse error");for(var n=window.atob(t),a=n.length,r=new Uint8Array(a),c=0;c<a;c++)r[c]=n.charCodeAt(c);return new Blob([r],{type:t[0]})}},{key:"download",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=this._base64ToBlob(e),a=URL.createObjectURL(n),r=document.createElement("a");r.href=a,r.download=t?"".concat(t,".png"):"capture-".concat(Date.now(),".png"),r.click(),URL.revokeObjectURL(a)}}]),e}()),v=n(20),m=n.n(v);var g=function(e){return function(t){for(var n=t.data,a=0,r=n.length;a<r;a+=4){var c=n[a],i=n[a+1],u=n[a+2],o=n[a+3];n[a]=e[0][0]*c+e[0][1]*i+e[0][2]*u+e[0][3]*o+255*e[0][4],n[a+1]=e[1][0]*c+e[1][1]*i+e[1][2]*u+e[1][3]*o+255*e[1][4],n[a+2]=e[2][0]*c+e[2][1]*i+e[2][2]*u+e[2][3]*o+255*e[2][4],n[a+3]=e[3][0]*c+e[3][1]*i+e[3][2]*u+e[3][3]*o+255*e[3][4]}}}([[1,0,0,0,0],[0,1,0,0,0],[0,0,1,0,0],[3,-3,1,1,0]]),p=Object(a.forwardRef)((function(e,t){var n=e.stream,c=e.x,i=e.y,u=e.width,o=e.height,s=e.selected,f=e.onSelect,h=r.a.useRef(),b=Object(a.useRef)(null),v=Object(a.useRef)(),p=Object(a.useRef)(!1),j=Object(a.useState)({x:c,y:i}),O=Object(l.a)(j,2),w=O[0],k=O[1],E=Object(a.useState)({width:u,height:o}),y=Object(l.a)(E,2),C=y[0],x=y[1],S=Object(a.useCallback)((function(e){var t=e.target,n=function(e,t,n,a){var r={width:e,height:t};if(r.width>n){var c=n/r.width;r.height=r.height*c,r.width=r.width*c}if(r.height>a){var i=a/r.height;r.width=r.width*i,r.height=r.height*i}return r}(t.videoWidth,t.videoHeight,u,o);x(n)}),[u,o]),I=Object(a.useCallback)((function(e){k({x:e.target.x(),y:e.target.y()})}),[]),L=Object(a.useCallback)((function(e){f()}),[f]),R=Object(a.useMemo)((function(){var e=function(e){var t=document.createElement("video");return t.muted=!0,t.autoplay=!0,t.setAttribute("playsinline","true"),t.srcObject=e||null,t.play(),t}(n);return e.addEventListener("canplay",S),e}),[n,S]);return Object(a.useEffect)((function(){var e=h.current,t=b.current;s&&e&&t&&(e.setNode(t),e.getLayer().batchDraw())}),[h,b,s]),Object(a.useEffect)((function(){var e=b.current;if(e){var t=new m.a.Animation((function(){if(0!==e.width()&&0!==e.height()){var t=e.getLayer();t&&t.batchDraw(),e.cache()}}),e);return p.current||(t.start(),p.current=!1),v.current=t,function(){t.stop()}}}),[b,v,p,u,o]),Object(a.useImperativeHandle)(t,(function(){return{start:function(){v.current&&v.current.start()},stop:function(){v.current&&v.current.stop()},toggle:function(){return p.current=!p.current,v.current&&(p.current?v.current.stop():v.current.start()),p.current}}}),[v]),r.a.createElement(r.a.Fragment,null,r.a.createElement(d.Image,{filters:[g],x:w.x,y:w.y,width:C.width,height:C.height,image:R,ref:b,draggable:!0,onDragEnd:I,onClick:L}),s&&r.a.createElement(d.Transformer,{ref:h}))})),j=320,O=240,w=function(e){var t=e.image,n=e.stream,c=Object(a.useRef)(null),i=Object(a.useRef)(null),u=Object(a.useState)(),o=Object(l.a)(u,2),s=o[0],f=o[1],h=Object(a.useMemo)((function(){return{width:t?t.width:0,height:t?t.height:0}}),[t]),v=Object(a.useCallback)((function(){f(void 0)}),[]),m=Object(a.useCallback)((function(e){(e.target===e.target.getStage()||e.target.attrs.unselectable)&&f(void 0)}),[]),g=Object(a.useCallback)((function(e){return function(){f(e)}}),[]),w=Object(a.useCallback)((function(){i.current&&i.current.toggle()}),[i]),k=Object(a.useCallback)((function(){var e=c.current;if(e){var t=e.toDataURL();b.download(t)}}),[c]),E=Object(a.useMemo)((function(){if(t&&0!==h.width&&0!==h.height)return r.a.createElement(p,{ref:i,selected:"camera"===s,x:0,y:0,width:j,height:O,stream:n,onSelect:g("camera")})}),[t,h,n,s,g]);return r.a.createElement("div",{className:"editor-container"},r.a.createElement("div",{className:"editor",onMouseLeave:v},r.a.createElement(d.Stage,{className:"editor-layer",width:h.width,height:h.height,onMouseDown:m,ref:c},r.a.createElement(d.Layer,null,r.a.createElement(d.Image,{unselectable:!0,x:0,y:0,width:h.width,height:h.height,image:t||void 0}),E))),r.a.createElement("footer",{className:"editor-footer"},r.a.createElement("button",{type:"button",onClick:w,disabled:!E},"\u4e00\u6642\u505c\u6b62"),r.a.createElement("button",{type:"button",onClick:k,disabled:!E},"\u4fdd\u5b58")))},k=new(function(){function e(){Object(f.a)(this,e)}return Object(h.a)(e,[{key:"checkVideoStream",value:function(){var e=Object(s.a)(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,navigator.mediaDevices.getUserMedia({video:!0,audio:!1});case 2:return e.sent.getTracks().forEach((function(e){e.stop()})),e.abrupt("return",!0);case 5:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()},{key:"getVideoStream",value:function(e){var t={video:{deviceId:e,width:{ideal:1024},height:{ideal:768},frameRate:{ideal:60,min:20},facingMode:"user"},audio:!1};return navigator.mediaDevices.getUserMedia(t)}}]),e}()),E=function(){var e=Object(s.a)(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,n){var a=new FileReader;a.addEventListener("load",(function(){e(a.result)})),a.addEventListener("error",(function(e){n(e)})),a.readAsDataURL(t)})));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),y=function(e){var t=e.onChange,n=Object(a.useCallback)(function(){var e=Object(s.a)(o.a.mark((function e(n){var a,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.target.files){e.next=9;break}return e.next=3,E(n.target.files[0]);case 3:a=e.sent,(r=new Image).src=a,r.complete?t(r):r.addEventListener("load",(function(){t(r)})),e.next=10;break;case 9:t(null);case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),[t]);return r.a.createElement("input",{type:"file",accept:"image/*",onChange:n})},C=function(e){var t=e.deviceId,n=void 0===t?"deviceId":t,c=e.type,i=void 0===c?"audioinput":c,u=e.disabled,d=void 0!==u&&u,f=e.errorMessage,h=void 0===f?"-":f,b=e.onInit,v=e.onChange,m=Object(a.useState)([]),g=Object(l.a)(m,2),p=g[0],j=g[1],O=Object(a.useState)(n),w=Object(l.a)(O,2),k=w[0],E=w[1],y=Object(a.useMemo)((function(){return new Map}),[]),C=Object(a.useCallback)(Object(s.a)(o.a.mark((function e(){var t,a,r,c;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,navigator.mediaDevices.enumerateDevices();case 2:t=e.sent,(a=t.filter((function(e){return e.kind===i}))).forEach((function(e){y.set(e.deviceId,e)})),r=a[0]?a[0].deviceId:"default",(c=a.find((function(e){return e.deviceId===n})))&&(r=c.deviceId),j(a),E(r),b&&b(y.get(r));case 11:case"end":return e.stop()}}),e)}))),[y,i,n,b]);Object(a.useEffect)((function(){C()}),[C]),Object(a.useEffect)((function(){E(n)}),[n]);var x=Object(a.useCallback)((function(e){var t=e.target.value,n=y.get(t);n?(E(t),v&&v(n)):v&&v(void 0)}),[v,y]),S=Object(a.useMemo)((function(){return p.map((function(e){return r.a.createElement("option",{value:e.deviceId,key:e.deviceId},e.label)}))}),[p]);return 0===S.length&&S.push(r.a.createElement("option",{value:"default",key:0},h)),r.a.createElement("select",{value:k,onChange:x,disabled:d},S)},x=(n(88),function(){var e=function(){var e=Object(a.useState)(!1),t=Object(l.a)(e,2),n=t[0],r=t[1],c=Object(a.useState)(!1),i=Object(l.a)(c,2),u=i[0],d=i[1],f=Object(a.useCallback)(Object(s.a)(o.a.mark((function e(){var t;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,k.checkVideoStream();case 3:t=e.sent,d(t),e.next=11;break;case 7:e.prev=7,e.t0=e.catch(0),alert(e.t0),d(!1);case 11:return e.prev=11,r(!0),e.finish(11);case 14:case"end":return e.stop()}}),e,null,[[0,7,11,14]])}))),[]),h=Object(a.useCallback)(function(){var e=Object(s.a)(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",k.getVideoStream(t));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),[]);return Object(a.useEffect)((function(){f()}),[f]),{initialized:n,available:u,loadDevice:h}}(),t=e.initialized,n=e.available,c=e.loadDevice,i=Object(a.useState)(null),u=Object(l.a)(i,2),d=u[0],f=u[1],h=Object(a.useState)(),b=Object(l.a)(h,2),v=b[0],m=b[1],g=Object(a.useState)(null),p=Object(l.a)(g,2),j=p[0],O=p[1],E=Object(a.useCallback)(function(){var e=Object(s.a)(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:m(t?t.deviceId:void 0);case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),[]),x=Object(a.useCallback)((function(e){f(e)}),[]),S=Object(a.useCallback)((function(){v?c(v).then((function(e){O(e)}),(function(e){alert(e)})):O(null)}),[v,c]);return Object(a.useEffect)((function(){var e=j;return function(){e&&e.getTracks().forEach((function(e){e.stop()}))}}),[j]),t?n?r.a.createElement("div",{className:"app"},r.a.createElement("header",{className:"header"},r.a.createElement("div",{className:"header-form"},r.a.createElement(y,{onChange:x}),r.a.createElement(C,{type:"videoinput",deviceId:v,onChange:E}),r.a.createElement("button",{onClick:S},"\u30ab\u30e1\u30e9\u53d6\u308a\u8fbc\u307f"))),r.a.createElement(w,{image:d,stream:j})):r.a.createElement("div",{className:"error"},"\u30ab\u30e1\u30e9\u3078\u306e\u30a2\u30af\u30bb\u30b9\u304c\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f"):r.a.createElement("div",{className:"loading"},"Loading...")});Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));i.a.render(r.a.createElement(x,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()}))}},[[32,1,2]]]);
//# sourceMappingURL=main.402d27ca.chunk.js.map